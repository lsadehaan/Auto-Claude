# Auto-Claude Web Deployment

This document describes the web deployment setup for Auto-Claude.

## Server Details

- **IP**: 100.112.18.81 (NetBird VPN)
- **Hostname**: claude
- **URLs**:
  - `https://claude` (primary)
  - `https://100.112.18.81` (alternative)

## Architecture

```
NetBird VPN (100.112.18.81)
    ↓
Caddy Reverse Proxy (Ports 80/443)
    ↓
Auto-Claude Web Server (Port 3001)
    ↓
Python Backend (spawned subprocess)
```

## Services

All services run via systemd:

- `auto-claude.service` - Web server
- `caddy.service` - Reverse proxy with HTTPS
- `actions.runner.lsadehaan-Auto-Claude.auto-claude-server.service` - GitHub Actions runner

## SSL Certificate

The server uses a self-signed certificate generated by Caddy. To avoid browser warnings:

1. Open `caddy-root-ca.crt` (in this repository)
2. **Windows**: Double-click → Install Certificate → Place in "Trusted Root Certification Authorities"
3. **Mac**: Open Keychain Access → File → Import → Select certificate → Double-click → Trust → Always Trust
4. **Linux**:
   ```bash
   sudo cp caddy-root-ca.crt /usr/local/share/ca-certificates/
   sudo update-ca-certificates
   ```

## Deployment

### Automated via GitHub Actions

Push to `develop` or `main` branch triggers automatic deployment:

```bash
git push origin develop
```

The workflow:
1. Builds frontend and web-server
2. Installs dependencies
3. Restarts systemd service
4. Runs health checks

### Manual Deployment

SSH to server:

```bash
ssh root@100.112.18.81

cd /opt/auto-claude
git pull origin develop

# Install dependencies
cd apps/backend
uv pip install -r requirements.txt

cd ../frontend
npm install
npm run web:build

cd ../web-server
npm install
npm run build

# Restart service
sudo systemctl restart auto-claude
```

## Configuration

### Environment Variables

**Backend** (`apps/backend/.env`):
```env
CLAUDE_CODE_OAUTH_TOKEN=<your-token>
GRAPHITI_ENABLED=false
```

**Web Server** (`apps/web-server/.env`):
```env
PORT=3001
HOST=0.0.0.0
NODE_ENV=development
BACKEND_PATH=/opt/auto-claude/apps/backend
DATA_PATH=/opt/auto-claude-data
FRONTEND_DIST_PATH=/opt/auto-claude/apps/frontend/dist-web
CLAUDE_CODE_OAUTH_TOKEN=<your-token>
```

### Caddy Configuration

Located at `/etc/caddy/Caddyfile`:

```caddyfile
https://claude, https://100.112.18.81 {
    reverse_proxy localhost:3001
    tls internal
}

http://claude, http://100.112.18.81 {
    redir https://{host}{uri}
}
```

## Monitoring

### Check Service Status

```bash
ssh root@100.112.18.81

# Check all services
sudo systemctl status auto-claude
sudo systemctl status caddy
sudo systemctl status actions.runner.lsadehaan-Auto-Claude.auto-claude-server

# View logs
sudo journalctl -u auto-claude -f
sudo journalctl -u caddy -f
```

### Health Check

```bash
curl https://claude/api/health
```

## Troubleshooting

### Service won't start

```bash
# Check logs
sudo journalctl -u auto-claude -n 50

# Common issues:
# - Missing CLAUDE_CODE_OAUTH_TOKEN in .env
# - Python backend not found
# - Node modules not installed
```

### SSL Certificate Issues

```bash
# Regenerate certificate
sudo systemctl restart caddy

# Check Caddy logs
sudo journalctl -u caddy -n 50
```

### GitHub Actions Runner Not Working

```bash
# Check runner status
sudo systemctl status actions.runner.lsadehaan-Auto-Claude.auto-claude-server

# Restart runner
sudo systemctl restart actions.runner.lsadehaan-Auto-Claude.auto-claude-server
```

## Security

- Server is VPN-only (NetBird), not exposed to public internet
- Authentication: Development mode (no password) - VPN provides security
- HTTPS with self-signed certificate for encrypted communication
- To enable password auth: Set `NODE_ENV=production` and run `npm run setup-password`
